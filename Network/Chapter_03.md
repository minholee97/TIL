### 1. 케이블과 리피터, 허브 속을 신호가 흘러간다
#### 1. 하나하나의 패킷이 독립된 것으로 동작
- 컴퓨터에서 송신된 패킷은 허브나 라우터라는 중계 장치에 의해 중계되어 목적지를 향해 진행함
- 애플리케이션의 데이터나 TCP 프로토콜의 제어 정보의 내용은 패킷을 운반하는 동작에 영향을 주지않으므로 HTTP 메시지, TCP의 수신 확인, 시퀀스 번호 등 모든게 무시.
#### 2. LAN 케이블은 신호를 약화시키지 않는 것이 핵심
- LAN 어댑터의 PHY(MAU) 회로에서 전기 신호로 바꾼 패킷은 RJ-45 커넥터를 통해 트위스트 페어 케이블에 들어 감
- 이더넷의 신호는 플러스와 마이너스 전압임, LAN 어댑터의 PHY(MAU) 회로의 플러스와 마이너스 신호 단자에서 신호가 나옴
- 케이블을 통과하는 동안 에너지가 조금씩 떨어지므로 케이블의 길이가 길수록 신호가 약해짐
- 송신측에서 각진 신호를 보내도 신호의 각진 부분은 전압이 급격하게 높으므로 주파수가 높다는 의미인데 주파수가 높으면 전파 방출량이 높아 전파로 방출된 만큼 에너지가 손실되어 각이 뭉개짐
- 여기에 잡음까지 더해지면 신호가 변형되어 0과 1을 잘못 판독할 수 있음
#### 3. '꼼'은 잡음을 방지하기 위한 방법
- LAN 케이블로 사용하는 트위스트 페어 케이블은 신호선을 마주 꼬아서 잡음을 어느정도 막을 수 있음
- 잡음의 원인은 케이블 주위에서 발생하는 전자파인데 전자파가 금속같은 도전체에 닿으면 그안에 전류가 발생하는 성질이 있음
- 이 때문에 케이블의 주위에 전자파가 있으면 신호와는 다른 전류가 케이블 안에 흐름
- 신호도 전압에 의해 생기는 전류인데 이게 섞이면 신호의 파형이 변형되버려서 이걸 잡음이라고 함
- 케이블에 영향을 받는 전자파는 두 종류가 있는데 그 중 하나는 모니터, 형광등, CRT 모니터와 같은 기기에서 누설되는 전자파임
- 이것들은 케이블 밖에서 오는 것이므로 선을 꼬아서 막을 수 있음
- 신호선은 금속으로 만들어져서 거기에 전자파가 닿으면 전자파의 진행 방향의 오른쪽으로 도는 전류가 생기는 성질이 있음
- 선을 마주 꼬면 나선형이 되어 꼰 옆의 선에서 전류가 흐르는 방향이 반대가 됨
- 따라서 꼬았을때 맞닿는 부분에서 서로 상쇄되어 잡음 전류가 약해짐
- 또 하나는 같은 케이블 안의 인접한 신호선에서 누설되는 전자파임
- 신호선 안에는 신호라는 전류가 흐르므로 전류에 의해 주위에 전자파가 생기는데 이것이 다른 신호선에 대한 잡음이 됨, 이거를 크로스토크 라고함
- 이것을 막는 것도 신호선을 마주 꼬는 것임, 한 개의 케이블에 넣은 신호선을 꼬는 간격을 조금씩 다르게해서 어떤 부분에서는 플러스 신호가 가깝고 어떤 부분에서는 마이너스 신호가 가까워서 잡음의 영향이 반대가 되므로 줄어듬
- 이 방법외에도 신호선 사이에 격리판을 넣거나 금속성 차폐 피복을 입히는 등의 대책이 있음
#### 4. 리피터 허브는 연결되어 있는 전체 케이블에 신호를 송신함
- 신호가 리피터 허브에 도달하면 LAN 전체에 신호가 흩어지고 MAC 주소가 일치하는 기기만 패킷을 수신함
- 리피터 허브 내부는 LAN 어댑터와 유사하게 RJ-45 커넥터에서 받아서 PHY(MAU) 회로랑 연결되는데 송신단자에서 보낸 신호를 수신단자로 받기 위해 선이 크로스 되어있음
- PHY(MAU)에 도달한 신호는 리피터 회로에 들어가고 리피터 회로는 리피터 허브의 커넥터 부분에 신호를 뿌림
### 2. 스위칭 허브의 패킷 중계 동작
#### 1. 스위칭 허브는 주소 테이블로 중계
- 신호가 커넥터에 도달하고 PHY(MAU) 회로에서 수신한 뒤 신호 형식을 공통 형식으로 변환 후 MAC 회로에 들어감
- 여기서 디지털 데이터로 변환하고 FCS를 대조해서 오류 유무를 검사하고 이상이 없으면 버퍼 메모리에 저장 (LAN 어댑터와 유사한데 같은 회로가 안에 있다고 생각)
- PC에 다수의 LAN 어댑터를 장착하고 모든 패킷을 수신하는 동작을 수행하도록 설정하면 스위칭 허브와 유사
- LAN 어댑터와 달리 MAC 회로에는 MAC 주소가 할당되어 있지 않음
- 패킷을 버퍼 메모리에 저장하면 다음 수신처 MAC 주소와 일치하는 것이 MAC 주소표에 등록되어 있는지 조사
- 주소표에는 MAC 주소랑 그 기기가 어느 포트랑 연결되어 있는지 정보가 있어서 이 패킷을 어느 포트로 내보낼지 결정 가능함
- 포트를 정했다면 스위치 회로를 경유해서 패킷을 송신측 포트로 보냄
- 스위치 회로를 경유해서 송신측의 포트에 패킷을 운반하면 MAC회로나 PHY(MAU)회로가 송신을 수행해서 케이블에 신호가 흐름
- 반이중 통신의 경우 케이블에 흘리는 과정이 LAN 어댑터와 동일함
#### 2. MAC 주소 테이블을 등록 및 갱신
- 스위칭 허브는 패킷을 중계할 때 MAC 주소표의 내용을 갱신하는 동작도 실행
- 패킷 수신시 송신처 MAC 주소와 입력 포트를 세트로 주소표에 등록
- 또한 일정 시간이 경과하면 오래된 MAC 주소표의 내용을 삭제
#### 3. 예외적인 동작
- 스위칭 허브에 리피터 허브가 접속되어 있는 경우 리피터 허브에 패킷을 보내면 목적지와 스위치 둘 다 송신하게 되고 스위치에서는 목적지가 있는 리피터로 다시 보내기 때문에 목적지에서는 두 개의 패킷을 받게 되므로 스위치는 패킷을 수신한 포트와 송신하는 포트가 같으면 폐끼함
- MAC 주소표에 일치하는 MAC 주소가 없는 경우 수신한 포트를 제외한 모든 포트에 패킷을 송신함.
#### 4. 전이중 모드에서 송, 수신을 동시 싷행
- 스위칭 허브는 송, 수신을 동시에 하는 전이중 모드가 가능함 (리피터는 불가)
- 트위스트 페어 케이블의 신호선은 송, 수신이 나뉘어져 있고, 스위치 허브의 포트나 LAN 어댑터에도 PHY(MAU) 회로와 MAC 회로 내부도 송, 수신이 나뉘어 있어서 충돌하지 않음
- 스위칭 허브는 전이중 모드를 사용하여 송신과 수신을 동시에 실행
#### 5. 최적의 전송 속도로 보내는 자동 조정
- 접속한 상대가 전이중 모드를 지원하는지와 전송 속도를 검출하고 동작 모드를 전환함
- 이더넷은 데이터가 흐르고 있지 않을때 링크 펄스라는 신호를 흘려서 상대가 올바르게 작동하는지 케이블이 단선되지 않았는지 확인함
- 이 링크 펄스 신호에 자신의 전송 속도와 지원 가능 모드를 통지하고 최적의 조합을 자신에게 설정함
#### 6. 스위칭 허브는 복수의 중계 동작을 동시 실행
- 리피터는 들어온 신호를 모든 포트에서 뿌리므로 동시에 뿌리면 충돌할 수 있으나 리피터는 수신처 MAC 주소의 포트만 송신하므로 다른 포트에 별도의 패킷을 뿌릴 수 있음 
### 3. 라우터의 패킷 중계 동작
#### 1. 라우터의 기본
- 리피터 허브나 스위칭 허브를 경유한 패킷은 결국 라우터에 도착하고 라우터에서 다음 라우터로 중계됨
- 라우터의 내부는 포트 부분, 중계 부분으로 구성됨
- 포트 부분은 송, 수신처가 되어 패킷을 송, 수신하는데 각 포트에는 MAC 주소, IP 주소가 할당되어있어 송, 수신처 역할이 가능함
- 포트 부분에 할당된 MAC 주소가 수신한 패킷의 MAC 주소와 일치하는 경우만 패킷을 수신함
#### 2. 라우팅 테이블에 등록된 정보
- 스위칭 허브는 패킷 MAC 헤더의 MAC 주소로 중계 대상을 판단하지만, 라우터는 IP 헤더의 IP 주소로 중계 대상을 판단함
- 라우팅 테이블은 다음과 같이 구성되어있다.
- 1) Destination : 수신처의 IP 주소, 이 주소와 패킷의 IP 주소를 비교하게 된다.
- 2) Netmask : Destination과 패킷의 IP 주소를 비교하기 전에 Netmask와 패킷의 IP 주소를 AND 연산을 수행하고 연산 결과를 Destination과 비교를 한다. (Netmask가 0.0.0.0이면 어떠한 IP 주소와도 일치하게 되므로 이는 Default Gateway를 의미함, Prefix가 큰 순서대로 비교하므로 문제 없음(255.255.255.0 = 24))
- 3) Gateway : Destination으로 향하기 위해 가야하는 장치의 주소, 비어있으면 인터페이스로 직접 보낼 수 있음을 의미
- 4) Interface : 패킷을 밖으로 전송할 인터페이스(포트)
- 5) Metric : 수신처가 멀리 있는지 가까이 있는지, 대상까지 경로의 hop 수를 나타냄
- 스위치는 패킷 중계를 수행하면서 MAC 주소 테이블에 등록하지만 라우터는 중계중에 라우팅 테이블을 건드리지 않고 참조만함.
- 라우팅 테이블은 사람이 직접 갱신할 수 있고 라우팅 프로토콜을 사용하여 라우터들끼리 경로 정보를 교환하고 라우터 자체에서 경로표 등록
#### 3. 라우터의 패킷 수신 동작
- 라우터의 포트는 여러 종류가 있는데 이더넷 포트의 경우 LAN 어댑터와 거의 같음
- 신호가 커넥터에 도달하면 PHY(MAU) 회로와 MAC 회로에서 신호를 디지털 데이터로 변환하고 패킷 끝의 FCS를 대조하여 오류를 점검함
- 정상이면 MAC 헤더의 수신처 MAC 주소가 자신에게 해당하는지 조사해서 패킷을 수신 버퍼 메모리에 저장함 (해당하지 않거나 비정상 패킷이면 폐기)
#### 4. 라우팅 테이블을 검색해서 출력 포트를 발견한다
- 라우터의 패킷 수신 동작이 끝나면 맨 앞의 MAC 헤더를 폐기한다.
- MAC 헤더 뒤에 IP 헤더를 보고 패킷 중계 동작을 수행함
- 수신처 IP 주소와 라우팅 테이블에 Destination의 항목이 일치하는 행을 검색하는데 비교할 때 넷마스크와 IP 주소를 AND 연산한 후 비교를 함
- 복수의 행이 일치하면 행들중 넷마스크의 크기가 큰(AND 연산을 가장 많이한) 행을 선택함. 범위가 축소되고 구체적임을 의미
- 그래도 같은 행이 있다면 매트릭 값이 작은 쪽을 우선하여 중계 대상으로 선택함
- 일치하지 않는 행이 한 개도 발견되지 않는 경우엔 패킷을 폐기하고 ICMP 메시지로 송신처에게 이 사실을 통지함
- 스위치는 중계 대상이 발견되지 않으면 모든 포트에 패킷을 뿌리는데 스위치가 연결하는 네트워크는 규모가 크지 않으므로 문제되지 않음
- 라우터가 연결하는 네트워크는 매우 큰 규모이므로 모든 포트에 패킷을 뿌리면 네트워크가 혼잡해지므로 중계 대상이 분명하지 않은 패킷은 폐기함
#### 5. 해당하는 경로가 없는 경우에 선택하는 기본 경로
- 라우팅 테이블에 넷마스크가 0.0.0.0으로 되어있는 행이 있는데, 이렇게 하면 모든 주소와 일치하게 된다.
- 이 행의 Gateway 항목에 인터넷으로 나가는 라우터를 등록하면 다른 행에 일치하는 것이 없는 경우 패킷을 그곳으로 중계함
- 여기에 등록한 라우터를 기본 게이트웨이라고 하며 TCP/IP 설정화면의 기본 게이트웨이와 같은 의미
#### 6. 패킷은 유효기한이 있음
- 라우팅 테이블에서 중계 대상을 찾으면 패킷을 출력 포트로 옮기고 여기서 송신하는데 그 전에 해야할 일이 있음
- IP 헤더 필드중 TTL 이라는 생존 기간 필드를 갱신하는 것으로 라우터를 경유할 때마다 이 값을 1씩 줄이다가 0이되면 패킷을 폐기함
- 패킷이 같은 장소를 순환하는 사태를 막기 위함
#### 7. 큰 패킷은 조각 나누기 기능으로 분할함
- 라우터의 포트 부분은 이더넷뿐만 아니라 이더넷외의 LAN이나 통신 회선의 경우도 있음
- 이런 종류에 따라 패킷의 최대 길이가 달라지므로 출력 포트의 패킷 길이가 입력측 보다 작은 경우도 있음
- ADSL이나 FTTH 등 광대역 엑세스 회선에서 PPPoE 프로토콜을 사용하는 경우 여분의 헤더를 부가해서 패킷의 실질 길이가 짧아지는 경우도 있음
- 어느 경우던 중계하는 패킷의 크기가 출력측의 패킷 최대 길이를 초과하면 그 상태로는 패킷을 송신할 수 없음
- 이러한 경우엔 IP 프로토콜에 규정된 프래그멘테이션을 통해 패킷을 분할해서 짧게 만들어서 중계함
- IP 입장에서는 TCP 헤더 + 데이터 조각이 받은 하나의 데이터이므로 이 데이터 자체를 분할해서 패킷을 조각냄
- 조각 나누기는 출력측의 MTU를 계산해서 중계하는 패킷을 그대로 보낼 수 있는지 확인하고 보낼 수 없으면 IP 헤더의 플래그 필드를 확인해서 분할이 가능하면 MTU에 맞춰서 조각내서 전송함
- 분할할 수 없는 경우는 송신처에서 분할 불가로 지정하거나 이미 프래그멘테이션으로 분할된 경우를 말함
#### 8. 라우터의 송신 동작은 컴퓨터와 같음
- 이렇게 해서 송신 전의 일이 끝나므로 패킷의 송신 동작으로 넘어감 (IP 헤더의 체크섬을 재계산 해야하는데 체크섬은 신뢰성이 낮아서 대부분의 라우터가 체크섬을 검사하지 않기 때문에 사실상 체크섬은 없는 것이나 마찬가지임)
- 이제 출력측의 포트에 맞게 이더넷이라면 이더넷 규칙으로, ADSL이라면 ADSL 규칙으로 패킷을 신호로 변환하여 송신함
- 이더넷의 경우 프로토콜 스택의 IP 담당 부분이 패킷을 보낼 때처럼 패킷 앞에 MAC 헤더를 부가하고 여기에 값을 설정해서 패킷을 완성시킨 후 전기 신호로 변환해서 보냄
- 먼저 MAC 헤더 맨 앞에 있는 수신처 MAC 주소 필드에 값을 설정하기 위해 라우팅 테이블의 Gateway 항목에서 판단하는데 Gateway 항목에 IP 주소가 쓰여있으면 이 IP 주소가 건네줄 상대이고, 이 곳이 비어있으면 IP 헤더의 수신처 IP 주소가 건네줄 상대가 됨
- 이를 통해 건네줄 IP 주소가 결정되면 ARP로 IP 주소에서 MAC 주소를 조사하고 헤더에 설정함
- 송신처의 MAC 주소는 현재 출력포트에 할당된 MAC 주소를 설정함 (타입필드는 0800, IP)
- 패킷을 신호로 변환하여 송신, 신호는 스위치를 경유하여 다음 라우터에 도달(수신처 MAC 주소에 다음 라우터의 주소가 쓰여 있으므로)
#### 9. 라우터와 스위치의 관계
- IP라는 구조는 스스로 패킷을 운반하는 수단이 없으므로 패킷을 이더넷의 패킷 데이터 부분에 IP 패킷을 넣고 이더넷 원리로 다음 라우터까지 전송하는 것임
- 라우터는 IP의 개념에 기초해서 만들어졌고 스위치는 이더넷에 기초해서 만들어졌기 떄문에 IP와 이더넷 관계는 라우터와 스위치의 관계를 나타냄
- 즉 라우터는 패킷을 운반하는 일을 스위치에게 의뢰하는 것이라 할 수 있음
- 추가적으로 스위치 대신 리피터를 써도 되고 스위치나 리피터 없이 크로스케이블로 라우터의 포트를 직접 연결해도 상관없음, 패킷을 운반하는 작업은 이더넷의 규칙에 맞게 운반하는 것이면 무엇이든 좋음
- 지금까지 예시는 라우터와 스위치의 순수한 기능을 가정했지만 실제 라우터는 스위치 기능을 내장한 기종도 있고 유형이 많음
- 하지만 기본적인 동작 원리는 전부 동일하므로 라우터와 스위치를 추출해서 생각하면 적용이 가능함
- 패킷을 어디까지 운반할 것인가 생각해보면 라우터가 스위치에게 의뢰할 때의 개념을 이해할 수 있음
- IP가 이더넷에 의뢰하는 것은 최종 목적지까지가 아닌 다음 라우터에 패킷을 운반하도록 하는건데 MAC 헤더를 만들때 라우팅 테이블에서 다음 라우터 IP 주소를 확인하고 ARP로 조사한 MAC 주소를 기록해서 의뢰하는 것임
- 즉 통신 상대까지 패킷을 전달하는 전체 동작은 IP(라우터)가 하고 이 동작을 할 때 다음 라우터까지 패킷을 운반하는 부분은 이더넷(스위치)가 담당하는 것임
- 또한 네트워크는 이더넷뿐만 아니라 무선 LAN도 있고 통신 회선도 있는데 그냥 이더넷을 이것들로 치환한다고 생각하면 됨
### 4. 라우터 부가기능
#### 1. 주소 변환으로 IP 주소를 효율적으로 이용
- 라우터는 기본 동작과 더불어 주소 변환과 패킷 필터링 부가 기능이 있음
- 먼저 주소 변환 기능이 나온 이유는 옛날에는 사내 네트워크의 기기들을 포함한 모든 인터넷에 접속하는 기기들은 고유의 IP 주소를 가지게 했는데 인터넷이 일반인들에게 보급되면서 IP 주소가 고갈될 수 도 있다는 문제가 발생함
- 그래서 사내 네트워크의 PC들의 주소들은 다른 사내 네트워크의 PC들의 주소들과 겹쳐도 서로 통신하지 않으므로 문제가 없다고 판단
- 사내용 주소 프라이빗 주소와, 이전의 고유한 주소 글로벌 주소로 나누었음
- 문제는 사내 네트워크는 완전히 독립되지 않고 인터넷에 연결되어있음
- 그래서 사내 네트워크에는 프라이빗 주소를 할당하되 인터넷과 직접 패킷을 주고받지 않도록 접속하는데 이게 주소 변환임
#### 2. 주소 변환의 기본 동작
- 주소 변환 장치(라우터)는 글로벌 주소와 프라이빗 주소의 대응표를 가지고 있고 프라이빗 주소에서 인터넷에 접속을 하면 송신처의 IP주소를 글로벌 주소로, 포트번호를 미사용 번호를 선택해서 변환하고 패킷을 보냄.
- 그리고 변환한 내용을 대응표에 기록하고 응답을 받으면 대응표에 기록한 내용대로 프라이빗 주소와 포트번호로 바꾸어 패킷을 보냄.
- 이러한 개념은 가정용 LAN에서도 동일
#### 3. 포트 번호를 바꿔쓰는 이유
- 위에서 포트 번호를 바꿔쓰는 이유는 주소만 글로벌 주소로 바꾸게 되면 프라이빗 주소와 글로벌 주소가 1대 1로 대응하게 되고 인터넷에 접속하는 대수만큼 글로벌 주소가 필요하게 됨
- 하지만 포트 번호는 클라이언트 내에 비어있는 것들이 많아서 무작위로 선택해서 사용하면 이용 효율이 높아짐
#### 4. 인터넷에서 회사로 엑세스
- 사내 -> 인터넷 으로 엑세스 하는 경우는 대응표에 등록되어있지 않아도 패킷을 중계할 수 있음
- 주소 변환 장치(라우터)에 바꿔쓰는 글로벌 주소가 등록되어있고 포트 번호는 적당히 비어있는 것을 사용하면 되므로 변환 장치에서 판단할 수 있기 때문
- 인터넷 -> 사내 의 경우는 대응표에 등록되어 있지 않으면 중계할 수 없음
- 이것은 인터넷에서 액세스하지 않는 기기에는 인터넷 측에서 패킷을 송신할 수 없다는 말 (부정 침입 방지)
- 사내에 엑세스하기를 원한다면 사전에 대응표를 수동으로 등록해 두면 됨
- 보통 공개용 서버는 주소 변환 장치 밖에 글로벌 주소를 할당하지만 서버의 프라이빗 주소를 주소 변환 장치에 수동으로 등록해 두면 사내에 있는 프라이빗 주소를 할당한 서버를 공개할 수도 있음 (이렇게 한 경우 주소 변환 장치에 등록한 글로벌 주소를 DNS 서버에 등록해야 함)
#### 5. 라우터의 패킷 필터링 기능
- 패킷 필터링 역시 라우터의 부가 기능 중 하나, 패킷을 중계할 때 MAC 헤더, IP 헤더 TCP 헤더에 기록된 내용을 조사하고 패킷을 중계할지 폐기할지 판단
- 대부분의 방화벽이라는 기기나 소프트웨어는 이 원리를 이용해서 부정 침입을 방지함
