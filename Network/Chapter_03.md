### 1. 케이블과 리피터, 허브 속을 신호가 흘러간다
#### 1. 하나하나의 패킷이 독립된 것으로 동작
- 컴퓨터에서 송신된 패킷은 허브나 라우터라는 중계 장치에 의해 중계되어 목적지를 향해 진행함
- 애플리케이션의 데이터나 TCP 프로토콜의 제어 정보의 내용은 패킷을 운반하는 동작에 영향을 주지않으므로 HTTP 메시지, TCP의 수신 확인, 시퀀스 번호 등 모든게 무시.
#### 2. LAN 케이블은 신호를 약화시키지 않는 것이 핵심
- LAN 어댑터의 PHY(MAU) 회로에서 전기 신호로 바꾼 패킷은 RJ-45 커넥터를 통해 트위스트 페어 케이블에 들어 감
- 이더넷의 신호는 플러스와 마이너스 전압임, LAN 어댑터의 PHY(MAU) 회로의 플러스와 마이너스 신호 단자에서 신호가 나옴
- 케이블을 통과하는 동안 에너지가 조금씩 떨어지므로 케이블의 길이가 길수록 신호가 약해짐
- 송신측에서 각진 신호를 보내도 신호의 각진 부분은 전압이 급격하게 높으므로 주파수가 높다는 의미인데 주파수가 높으면 전파 방출량이 높아 전파로 방출된 만큼 에너지가 손실되어 각이 뭉개짐
- 여기에 잡음까지 더해지면 신호가 변형되어 0과 1을 잘못 판독할 수 있음
#### 3. '꼼'은 잡음을 방지하기 위한 방법
- LAN 케이블로 사용하는 트위스트 페어 케이블은 신호선을 마주 꼬아서 잡음을 어느정도 막을 수 있음
- 잡음의 원인은 케이블 주위에서 발생하는 전자파인데 전자파가 금속같은 도전체에 닿으면 그안에 전류가 발생하는 성질이 있음
- 이 때문에 케이블의 주위에 전자파가 있으면 신호와는 다른 전류가 케이블 안에 흐름
- 신호도 전압에 의해 생기는 전류인데 이게 섞이면 신호의 파형이 변형되버려서 이걸 잡음이라고 함
- 케이블에 영향을 받는 전자파는 두 종류가 있는데 그 중 하나는 모니터, 형광등, CRT 모니터와 같은 기기에서 누설되는 전자파임
- 이것들은 케이블 밖에서 오는 것이므로 선을 꼬아서 막을 수 있음
- 신호선은 금속으로 만들어져서 거기에 전자파가 닿으면 전자파의 진행 방향의 오른쪽으로 도는 전류가 생기는 성질이 있음
- 선을 마주 꼬면 나선형이 되어 꼰 옆의 선에서 전류가 흐르는 방향이 반대가 됨
- 따라서 꼬았을때 맞닿는 부분에서 서로 상쇄되어 잡음 전류가 약해짐
- 또 하나는 같은 케이블 안의 인접한 신호선에서 누설되는 전자파임
- 신호선 안에는 신호라는 전류가 흐르므로 전류에 의해 주위에 전자파가 생기는데 이것이 다른 신호선에 대한 잡음이 됨, 이거를 크로스토크 라고함
- 이것을 막는 것도 신호선을 마주 꼬는 것임, 한 개의 케이블에 넣은 신호선을 꼬는 간격을 조금씩 다르게해서 어떤 부분에서는 플러스 신호가 가깝고 어떤 부분에서는 마이너스 신호가 가까워서 잡음의 영향이 반대가 되므로 줄어듬
- 이 방법외에도 신호선 사이에 격리판을 넣거나 금속성 차폐 피복을 입히는 등의 대책이 있음
#### 4. 리피터 허브는 연결되어 있는 전체 케이블에 신호를 송신함
- 신호가 리피터 허브에 도달하면 LAN 전체에 신호가 흩어지고 MAC 주소가 일치하는 기기만 패킷을 수신함
- 리피터 허브 내부는 LAN 어댑터와 유사하게 RJ-45 커넥터에서 받아서 PHY(MAU) 회로랑 연결되는데 송신단자에서 보낸 신호를 수신단자로 받기 위해 선이 크로스 되어있음
- PHY(MAU)에 도달한 신호는 리피터 회로에 들어가고 리피터 회로는 리피터 허브의 커넥터 부분에 신호를 뿌림
### 2. 스위칭 허브의 패킷 중계 동작
#### 1. 스위칭 허브는 주소 테이블로 중계
- 신호가 커넥터에 도달하고 PHY(MAU) 회로에서 수신한 뒤 신호 형식을 공통 형식으로 변환 후 MAC 회로에 들어감
- 여기서 디지털 데이터로 변환하고 FCS를 대조해서 오류 유무를 검사하고 이상이 없으면 버퍼 메모리에 저장 (LAN 어댑터와 유사한데 같은 회로가 안에 있다고 생각)
- PC에 다수의 LAN 어댑터를 장착하고 모든 패킷을 수신하는 동작을 수행하도록 설정하면 스위칭 허브와 유사
- LAN 어댑터와 달리 MAC 회로에는 MAC 주소가 할당되어 있지 않음
- 패킷을 버퍼 메모리에 저장하면 다음 수신처 MAC 주소와 일치하는 것이 MAC 주소표에 등록되어 있는지 조사
- 주소표에는 MAC 주소랑 그 기기가 어느 포트랑 연결되어 있는지 정보가 있어서 이 패킷을 어느 포트로 내보낼지 결정 가능함
- 포트를 정했다면 스위치 회로를 경유해서 패킷을 송신측 포트로 보냄
- 스위치 회로를 경유해서 송신측의 포트에 패킷을 운반하면 MAC회로나 PHY(MAU)회로가 송신을 수행해서 케이블에 신호가 흐름
- 반이중 통신의 경우 케이블에 흘리는 과정이 LAN 어댑터와 동일함
#### 2. MAC 주소 테이블을 등록 및 갱신
- 스위칭 허브는 패킷을 중계할 때 MAC 주소표의 내용을 갱신하는 동작도 실행
- 패킷 수신시 송신처 MAC 주소와 입력 포트를 세트로 주소표에 등록
- 또한 일정 시간이 경과하면 오래된 MAC 주소표의 내용을 삭제
#### 3. 예외적인 동작
- 스위칭 허브에 리피터 허브가 접속되어 있는 경우 리피터 허브에 패킷을 보내면 목적지와 스위치 둘 다 송신하게 되고 스위치에서는 목적지가 있는 리피터로 다시 보내기 때문에 목적지에서는 두 개의 패킷을 받게 되므로 스위치는 패킷을 수신한 포트와 송신하는 포트가 같으면 폐끼함
- MAC 주소표에 일치하는 MAC 주소가 없는 경우 수신한 포트를 제외한 모든 포트에 패킷을 송신함.
#### 4. 전이중 모드에서 송, 수신을 동시 싷행
- 스위칭 허브는 송, 수신을 동시에 하는 전이중 모드가 가능함 (리피터는 불가)
- 트위스트 페어 케이블의 신호선은 송, 수신이 나뉘어져 있고, 스위치 허브의 포트나 LAN 어댑터에도 PHY(MAU) 회로와 MAC 회로 내부도 송, 수신이 나뉘어 있어서 충돌하지 않음
- 스위칭 허브는 전이중 모드를 사용하여 송신과 수신을 동시에 실행
#### 5. 최적의 전송 속도로 보내는 자동 조정
- 접속한 상대가 전이중 모드를 지원하는지와 전송 속도를 검출하고 동작 모드를 전환함
- 이더넷은 데이터가 흐르고 있지 않을때 링크 펄스라는 신호를 흘려서 상대가 올바르게 작동하는지 케이블이 단선되지 않았는지 확인함
- 이 링크 펄스 신호에 자신의 전송 속도와 지원 가능 모드를 통지하고 최적의 조합을 자신에게 설정함
#### 6. 스위칭 허브는 복수의 중계 동작을 동시 실행
- 리피터는 들어온 신호를 모든 포트에서 뿌리므로 동시에 뿌리면 충돌할 수 있으나 리피터는 수신처 MAC 주소의 포트만 송신하므로 다른 포트에 별도의 패킷을 뿌릴 수 있음 
### 3. 라우터의 패킷 중계 동작
#### 1. 라우터의 기본
- 리피터 허브나 스위칭 허브를 경유한 패킷은 결국 라우터에 도착하고 라우터에서 다음 라우터로 중계됨
- 라우터의 내부는 포트 부분, 중계 부분으로 구성됨
- 포트 부분은 송, 수신처가 되어 패킷을 송, 수신하는데 각 포트에는 MAC 주소, IP 주소가 할당되어있어 송, 수신처 역할이 가능함
- 포트 부분에 할당된 MAC 주소가 수신한 패킷의 MAC 주소와 일치하는 경우만 패킷을 수신함
#### 2. 라우팅 테이블에 등록된 정보
- 스위칭 허브는 패킷 MAC 헤더의 MAC 주소로 중계 대상을 판단하지만, 라우터는 IP 헤더의 IP 주소로 중계 대상을 판단함
- 라우팅 테이블은 다음과 같이 구성되어있다.
- 1) Destination : 수신처의 IP 주소, 이 주소와 패킷의 IP 주소를 비교하게 된다.
- 2) Netmask : Destination과 패킷의 IP 주소를 비교하기 전에 Netmask와 패킷의 IP 주소를 AND 연산을 수행하고 연산 결과를 Destination과 비교를 한다. (Netmask가 0.0.0.0이면 어떠한 IP 주소와도 일치하게 되므로 이는 Default Gateway를 의미함, Prefix가 큰 순서대로 비교하므로 문제 없음(255.255.255.0 = 24))
- 3) Gateway : Destination으로 향하기 위해 가야하는 장치의 주소, 비어있으면 인터페이스로 직접 보낼 수 있음을 의미
- 4) Interface : 패킷을 밖으로 전송할 인터페이스(포트)
- 5) Metric : 수신처가 멀리 있는지 가까이 있는지, 대상까지 경로의 hop 수를 나타냄
- 스위치는 패킷 중계를 수행하면서 MAC 주소 테이블에 등록하지만 라우터는 중계중에 라우팅 테이블을 건드리지 않고 참조만함.
- 라우팅 테이블은 사람이 직접 갱신할 수 있고 라우팅 프로토콜을 사용하여 라우터들끼리 경로 정보를 교환하고 라우터 자체에서 경로표 등록
#### 3. 라우터의 패킷 수신 동작
- 라우터의 포트는 여러 종류가 있는데 이더넷 포트의 경우 LAN 어댑터와 거의 같음
- 신호가 커넥터에 도달하면 PHY(MAU) 회로와 MAC 회로에서 신호를 디지털 데이터로 변환하고 패킷 끝의 FCS를 대조하여 오류를 점검함
- 정상이면 MAC 헤더의 수신처 MAC 주소가 자신에게 해당하는지 조사해서 패킷을 수신 버퍼 메모리에 저장함 (해당하지 않거나 비정상 패킷이면 폐기)
#### 4. 라우팅 테이블을 검색해서 출력 포트를 발견한다
- 라우터의 패킷 수신 동작이 끝나면 맨 앞의 MAC 헤더를 폐기한다.
- MAC 헤더 뒤에 IP 헤더를 보고 패킷 중계 동작을 수행함
- 수신처 IP 주소와 라우팅 테이블에 Destination의 항목이 일치하는 행을 검색하는데 비교할 때 넷마스크와 IP 주소를 AND 연산한 후 비교를 함
- 복수의 행이 일치하면 행들중 넷마스크의 크기가 큰(AND 연산을 가장 많이한) 행을 선택함. 범위가 축소되고 구체적임을 의미
- 그래도 같은 행이 있다면 매트릭 값이 작은 쪽을 우선하여 중계 대상으로 선택함
- 일치하지 않는 행이 한 개도 발견되지 않는 경우엔 패킷을 폐기하고 ICMP 메시지로 송신처에게 이 사실을 통지함
- 스위치는 중계 대상이 발견되지 않으면 모든 포트에 패킷을 뿌리는데 스위치가 연결하는 네트워크는 규모가 크지 않으므로 문제되지 않음
- 라우터가 연결하는 네트워크는 매우 큰 규모이므로 모든 포트에 패킷을 뿌리면 네트워크가 혼잡해지므로 중계 대상이 분명하지 않은 패킷은 폐기함
#### 5. 해당하는 경로가 없는 경우에 선택하는 기본 경로
- 라우팅 테이블에 넷마스크가 0.0.0.0으로 되어있는 행이 있는데, 이렇게 하면 모든 주소와 일치하게 된다.
- 이 행의 Gateway 항목에 인터넷으로 나가는 라우터를 등록하면 다른 행에 일치하는 것이 없는 경우 패킷을 그곳으로 중계함
- 여기에 등록한 라우터를 기본 게이트웨이라고 하며 TCP/IP 설정화면의 기본 게이트웨이와 같은 의미
#### 6. 패킷은 유효기한이 있음
- 라우팅 테이블에서 중계 대상을 찾으면 패킷을 출력 포트로 옮기고 여기서 송신하는데 그 전에 해야할 일이 있음
- IP 헤더 필드중 TTL 이라는 생존 기간 필드를 갱신하는 것으로 라우터를 경유할 때마다 이 값을 1씩 줄이다가 0이되면 패킷을 폐기함
- 패킷이 같은 장소를 순환하는 사태를 막기 위함
#### 7.
